rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // --- Users ---
    match /users/{userId} {
      allow get: if true;
      allow list: if true;
      // Users can update their own profile, or other users can update their follower/following count during a follow action.
      allow update: if isSignedIn() && (request.auth.uid == userId || (request.writeFields.size() == 1 && ('followers' in request.writeFields || 'following' in request.writeFields)));
      
      match /favorites/{bookId} {
        allow read, write: if isSignedIn() && request.auth.uid == userId;
      }
      
      match /followers/{followerId} {
        allow read: if true;
        // The follower can add/remove themselves from the list
        allow create, delete: if isSignedIn() && request.auth.uid == followerId;
      }
      
      match /following/{followedUserId} {
        allow read: if true;
        // The user can manage their own following list
        allow create, delete: if isSignedIn() && request.auth.uid == userId;
      }

      match /notifications/{notificationId} {
        // A user can only read and update (e.g. mark as read) their own notifications
        allow read, update: if isSignedIn() && request.auth.uid == userId;
        // Notifications can be created by any signed-in user (e.g. for follows, comments, etc.) or by an admin for broadcasts.
        allow create: if isSignedIn() && request.resource.data.type in ['comment', 'follow', 'favorite', 'author_request', 'story_comment', 'broadcast'];
        allow delete: if false; 
      }
    }

    // --- Books & Chapters ---
    match /books/{bookId} {
      // Anyone can GET published books. Author/Admin can GET their own non-published books.
      allow get: if resource.data.status == 'published' || (isSignedIn() && (request.auth.uid == resource.data.authorId || isAdmin()));
      // Allow LIST operations. Firestore will still enforce GET rules on each document returned.
      allow list: if true;
      
      // Author/Admin can update their book. Any signed-in user can update favoriteCount.
      allow update: if isSignedIn() && (
                      (get(/databases/$(database)/documents/books/$(bookId)).data.authorId == request.auth.uid) ||
                      isAdmin() ||
                      (request.writeFields.size() == 1 && 'favoriteCount' in request.writeFields)
                    );
                    
      // Signed in users with 'penulis' or 'admin' role can create books.
      allow create: if isSignedIn() && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['penulis', 'admin']);
      
      // No one can delete books from the client.
      allow delete: if false;
      
      // Sub-collections
      match /chapters/{chapterId} {
        allow get: if get(/databases/$(database)/documents/books/$(bookId)).data.status == 'published' || (isSignedIn() && (request.auth.uid == get(/databases/$(database)/documents/books/$(bookId)).data.authorId || isAdmin()));
        allow list: if isSignedIn();
        allow write: if (isSignedIn() && (request.auth.uid == get(/databases/$(database)/documents/books/$(bookId)).data.authorId || isAdmin()));
      }
      
      match /comments/{commentId} {
        allow read: if true;
        allow create: if isSignedIn();
      }
    }
    
    // --- Author Requests ---
    match /authorRequests/{requestId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.userId;
      allow update, delete: if isAdmin();
    }
    
    // --- Chats & Messages ---
    function isParticipant(chatId) {
      return isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participantUids;
    }
    
    match /chats/{chatId} {
      allow create: if isSignedIn() && request.auth.uid in request.resource.data.participantUids;
      allow get, update: if isParticipant(chatId); // `update` is for lastMessage
      allow list: if isSignedIn();
      allow delete: if false;

      match /messages/{messageId} {
        allow read, create: if isParticipant(chatId);
        allow update, delete: if false;
      }
    }
    
    // --- Stories ---
    match /stories/{storyId} {
      function isStoryAuthor() {
        return request.auth.uid == get(/databases/$(database)/documents/stories/$(storyId)).data.authorId;
      }

      allow read: if isSignedIn();
      allow create: if isSignedIn() && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['penulis', 'admin']);
      allow update: if isStoryAuthor() || isAdmin() || (isSignedIn() && request.writeFields.size() == 1 && ('likes' in request.writeFields || 'commentCount' in request.writeFields || 'viewCount' in request.writeFields));
      allow delete: if isStoryAuthor() || isAdmin();

      match /comments/{commentId} {
        allow read, create: if isSignedIn();
      }
      
      match /likes/{userId} {
        allow read: if isSignedIn();
        allow create, delete: if request.auth.uid == userId;
      }

      match /views/{userId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn() && request.auth.uid == userId;
        allow update, delete: if false;
      }
    }
  }
}
