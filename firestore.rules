rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // --- Users ---
    match /users/{userId} {
      allow get: if true;
      allow list: if isSignedIn();
      // Users can update their own profile, or other users can update their follower count.
      allow update: if isSignedIn() && (request.auth.uid == userId || (request.writeFields.size() == 1 && 'followers' in request.writeFields));
      
      match /favorites/{bookId} {
        allow read, write: if isSignedIn() && request.auth.uid == userId;
      }
      
      match /followers/{followerId} {
        allow read: if true;
        // The follower can add/remove themselves from the list
        allow create, delete: if isSignedIn() && request.auth.uid == followerId;
      }
      
      match /following/{followedUserId} {
        allow read: if true;
        // The user can manage their own following list
        allow create, delete: if isSignedIn() && request.auth.uid == userId;
      }

      match /notifications/{notificationId} {
        // A user can only read and update (e.g. mark as read) their own notifications
        allow read, update: if isSignedIn() && request.auth.uid == userId;
        allow create, delete: if false; // Notifications are created by system/other users' actions
      }
    }

    // --- Books & Chapters ---
    match /books/{bookId} {
      // Anyone can read published books. Author/Admin can read their own non-published books.
      allow read: if resource.data.status == 'published' || (isSignedIn() && request.auth.uid == resource.data.authorId) || isAdmin();
      
      // Author/Admin can update their book. Any signed-in user can update favoriteCount.
      allow update: if isSignedIn() && (
                      (get(/databases/$(database)/documents/books/$(bookId)).data.authorId == request.auth.uid) ||
                      isAdmin() ||
                      (request.writeFields.size() == 1 && 'favoriteCount' in request.writeFields)
                    );
                    
      // Signed in users with 'penulis' or 'admin' role can create books.
      allow create: if isSignedIn() && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'penulis' || isAdmin());
      
      // No one can delete books from the client.
      allow delete: if false;
      
      // Sub-collections
      match /chapters/{chapterId} {
        allow read: if get(/databases/$(database)/documents/books/$(bookId)).data.status == 'published' || (isSignedIn() && request.auth.uid == get(/databases/$(database)/documents/books/$(bookId)).data.authorId) || isAdmin();
        allow write: if (isSignedIn() && request.auth.uid == get(/databases/$(database)/documents/books/$(bookId)).data.authorId) || isAdmin();
      }
      
      match /comments/{commentId} {
        allow read: if true;
        allow create: if isSignedIn();
      }
    }
    
    // --- Author Requests ---
    match /authorRequests/{requestId} {
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.userId;
      allow read, write: if isAdmin();
    }
    
    // --- Chats & Messages ---
    function isParticipant(chatId) {
      return isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participantUids;
    }
    
    match /chats/{chatId} {
      allow create: if isSignedIn() && request.auth.uid in request.resource.data.participantUids;
      allow read, update: if isParticipant(chatId); // `update` is for lastMessage
      allow delete: if false;

      match /messages/{messageId} {
        allow read, create: if isParticipant(chatId);
        allow update, delete: if false;
      }
    }
  }
}
